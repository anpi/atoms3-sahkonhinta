# AtomS3 Electricity Price Monitor - AI Development Guidelines

## Project Context
- **Hardware:** M5Stack AtomS3 (ESP32-S3) with 128x128 TFT display
- **Purpose:** Display Finnish electricity spot prices with cheapest period recommendations
- **API:** https://api.spot-hinta.fi/TodayAndDayForward?region=FI
- **Language:** Finnish UI labels ("Nyt", "Halvin", "Päivitetty")

## Development Principles
1. **Test-Driven Development:** Write tests before implementation for core algorithms
2. **Time Constraints:** Cheapest period must be 7:00-23:00 (washing machines can't run at night)
3. **90-Minute Periods:** Always calculate based on 6 consecutive 15-minute intervals
4. **No Auto-Commit:** Do not commit changes unless explicitly asked by the user
5. **Commit Messages:** Good titles are sufficient; if adding bullet points, make them intentional - focus on why and what's not obvious, not minutiae

## Testing
- Test framework: Google Test
- Run tests: `make test`
- Current coverage: 27 unit tests across 4 suites
- All tests must pass before committing

## Code Organization
```
src/
├── app/
│   ├── App.cpp/h           # Main controller
│   └── IdleManager.h       # Power management
├── pricing/
│   ├── PriceAnalyzer.cpp/h # Core algorithm (time constraints here!)
│   ├── PriceMonitor.cpp/h  # Model layer
│   ├── PriceApiClient.cpp/h # API integration
│   ├── PriceData.h         # Data structures
│   ├── IApiClient.h        # API interface
│   └── FetchGuard.h        # RAII fetch state
├── display/
│   ├── DisplayManager.cpp/h # View layer (Finnish UI, color coding)
│   ├── IDisplay.h          # Display interface
│   ├── IDisplayHardware.h  # Hardware abstraction
│   └── M5DisplayHardware.h # M5 implementation
├── network/
│   ├── WiFiManager.cpp/h   # Network management
│   ├── IWiFiHardware.h     # WiFi abstraction
│   └── M5WiFiHardware.h    # M5 WiFi implementation
└── timing/
    ├── TimerManager.cpp/h  # 15-minute update scheduling
    ├── ITimerHardware.h    # Timer abstraction
    └── M5TimerHardware.h   # M5 timer implementation

test/
├── pricing/
│   ├── test_price_analyzer_basic.cpp
│   ├── test_price_analyzer_time_constraints.cpp
│   ├── test_price_analyzer_edge_cases.cpp
│   ├── test_price_analyzer_datetime.cpp
│   ├── test_price_monitor.cpp
│   └── test_api_client.cpp
├── display/
│   └── test_display_manager.cpp
├── network/
│   └── test_wifi_manager.cpp
├── timing/
│   └── test_timer_manager.cpp
└── mocks/
    ├── MockDisplay.h
    └── MockApiClient.h
```

## Key Implementation Details
- **Color Thresholds:** Green <8¢, Yellow 8-15¢, Red >15¢ (RGB565: 0x0320, 0xFC60, 0xC800)
- **Brightness:** Default 1/255, bright mode 255/255 for 5 seconds after button/update
- **Update Schedule:** Every 15 minutes at :00, :15, :30, :45
- **Time Validation:** Reject periods crossing midnight or outside 7:00-23:00

## Documentation
- **requirements.md:** User story format, condensed test references (file names only)
- Keep requirements synchronized with implementation
- Update "Last Updated" date when modifying requirements.md

## Build & Deploy
- Build: `make` or `make build`
- Upload: `make upload`
- Test: `make test`
- Binary size target: <2MB (currently ~1.26MB)

## Common Gotchas
- Time parsing: Extract HH:MM from "YYYY-MM-DDTHH:MM:SS" format
- Midnight crossing: Check if endHour < startHour → invalid
- API failures: Maintain last valid data, don't crash
- Button response: Must be <100ms
